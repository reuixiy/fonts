# Web Font Auto-Subsetting Workflow v3.0 - Architecture Reorganization Plan

**Date Created**: 2025年6月18日  
**Version**: 3.0.0  
**Status**: In Progress  

## 📋 Overview

This document outlines the comprehensive architecture reorganization plan for v3.0, focusing on improved code organization, TypeScript-first configuration, and modular design patterns.

## 🎯 Goals

- **Better Code Organization**: Clear separation of concerns with modular architecture
- **TypeScript Configuration**: Replace JSON configs with type-safe TypeScript files
- **Interface-Based Design**: Implement dependency injection and loose coupling
- **Enhanced Maintainability**: Easier to extend, test, and maintain
- **No Test Overhead**: Focus on production code without testing infrastructure

## 🏗️ Current vs Proposed Structure

### Current Structure (v2.0)
```
src/
├── config/fonts.json          # JSON configuration
├── fontSubset.ts              # Font processing
├── index.ts                   # Main workflow
├── types.ts                   # All types mixed
└── versionChecker.ts          # Version checking

scripts/
├── download-fonts.ts          # Font downloading
├── generate-css.ts            # CSS generation
└── generate-license.ts        # License generation
```

### Proposed Structure (v3.0)
```
src/
├── core/                      # Core business logic
│   ├── interfaces/            # TypeScript interfaces & contracts
│   │   ├── index.ts           # Export all interfaces
│   │   ├── IVersionChecker.ts # Version checking contract
│   │   ├── IFontDownloader.ts # Download contract
│   │   ├── IFontProcessor.ts  # Font processing contract
│   │   ├── ICSSGenerator.ts   # CSS generation contract
│   │   ├── ILicenseGenerator.ts # License contract
│   │   └── IWorkflow.ts       # Workflow contract
│   │
│   ├── services/              # Service implementations
│   │   ├── index.ts           # Export all services
│   │   ├── WorkflowService.ts # Main workflow orchestration
│   │   ├── ErrorHandler.ts    # Centralized error handling
│   │   ├── Logger.ts          # Structured logging
│   │   └── ConfigValidator.ts # Configuration validation
│   │
│   └── base/                  # Base classes & abstractions
│       ├── BaseService.ts     # Common service functionality
│       ├── BaseProcessor.ts   # Common processing functionality
│       └── ServiceContainer.ts # Dependency injection container
│
├── modules/                   # Feature modules
│   ├── version/               # Version checking module
│   │   ├── index.ts           # Module exports
│   │   ├── VersionChecker.ts  # Main implementation
│   │   ├── GitHubVersionService.ts # GitHub API integration
│   │   ├── VersionCache.ts    # Version caching logic
│   │   └── types.ts           # Version-specific types
│   │
│   ├── download/              # Font downloading module
│   │   ├── index.ts           # Module exports
│   │   ├── FontDownloader.ts  # Main implementation
│   │   ├── GitHubDownloadService.ts # GitHub download logic
│   │   ├── FileValidator.ts   # File validation
│   │   └── types.ts           # Download-specific types
│   │
│   ├── processing/            # Font processing module
│   │   ├── index.ts           # Module exports
│   │   ├── FontProcessor.ts   # Main implementation
│   │   ├── ChunkingService.ts # Font chunking logic
│   │   ├── SubsetService.ts   # Font subsetting logic
│   │   └── types.ts           # Processing-specific types
│   │
│   ├── css/                   # CSS generation module
│   │   ├── index.ts           # Module exports
│   │   ├── CSSGenerator.ts    # Main implementation
│   │   ├── TemplateService.ts # CSS template handling
│   │   ├── MinificationService.ts # CSS minification
│   │   └── types.ts           # CSS-specific types
│   │
│   └── license/               # License generation module
│       ├── index.ts           # Module exports
│       ├── LicenseGenerator.ts # Main implementation
│       ├── LicenseCollector.ts # License data collection
│       └── types.ts           # License-specific types
│
├── config/                    # TypeScript configuration management
│   ├── index.ts               # Configuration loader & validator
│   ├── schema.ts              # Type definitions & validation
│   ├── fonts/                 # Font configurations (TypeScript)
│   │   ├── index.ts           # Combined font config
│   │   ├── chinese.ts         # Chinese fonts config
│   │   ├── english.ts         # English fonts config
│   │   └── variable.ts        # Variable fonts config
│   │
│   ├── build.ts               # Build configuration
│   ├── subsetting.ts          # Subsetting configuration
│   └── environments/          # Environment-specific configs
│       ├── development.ts
│       ├── production.ts
│       └── index.ts
│
├── utils/                     # Shared utilities
│   ├── index.ts               # Export all utilities
│   ├── FileSystem.ts          # File system operations
│   ├── PathUtils.ts           # Path manipulation
│   ├── HashUtils.ts           # Hashing utilities
│   ├── CompressionUtils.ts    # Compression utilities
│   └── ValidationUtils.ts     # Common validation
│
├── types/                     # Organized type definitions
│   ├── index.ts               # Export all types
│   ├── common.ts              # Common/shared types
│   ├── config.ts              # Configuration types
│   ├── workflow.ts            # Workflow types
│   ├── font.ts                # Font-related types
│   ├── api.ts                 # API response types
│   └── build.ts               # Build/output types
│
├── cli/                       # Command line interface
│   ├── index.ts               # CLI entry point
│   ├── commands/              # Command implementations
│   │   ├── build.ts           # Build command
│   │   ├── check.ts           # Version check command
│   │   ├── process.ts         # Process specific fonts
│   │   └── clean.ts           # Cleanup command
│   │
│   ├── utils/                 # CLI utilities
│   │   ├── args.ts            # Argument parsing
│   │   ├── help.ts            # Help text generation
│   │   └── validation.ts      # Input validation
│   │
│   └── types.ts               # CLI-specific types
│
└── index.ts                   # Main entry point (simplified)
```

## 🔧 Key Architectural Changes

### 1. Interface-Based Design
- All services implement interfaces for better abstraction
- Dependency injection for loose coupling
- Easy to mock and test (when tests are added later)

### 2. TypeScript-First Configuration
- Replace JSON configurations with TypeScript files
- Type-safe configuration with compile-time validation
- Better IntelliSense and refactoring support

### 3. Modular Architecture
- Feature-based module organization
- Clear boundaries between modules
- Easier to maintain and extend

### 4. Service Container
- Centralized dependency management
- Easy to swap implementations
- Better error handling and logging

## 📋 Migration Steps

### Phase 1: Core Infrastructure
1. Create new directory structure
2. Define interfaces for all services
3. Implement base classes and service container
4. Set up error handling and logging

### Phase 2: Configuration Migration
1. Convert JSON configs to TypeScript
2. Create configuration schemas and validation
3. Update configuration loading logic

### Phase 3: Module Migration
1. Move version checking to modules/version/
2. Move font downloading to modules/download/
3. Move font processing to modules/processing/
4. Move CSS generation to modules/css/
5. Move license generation to modules/license/

### Phase 4: CLI Enhancement
1. Implement command-based CLI
2. Add proper argument parsing
3. Enhance help and validation

### Phase 5: Integration & Testing
1. Update main entry point
2. Update package.json scripts
3. Update tsconfig.json paths
4. Test all workflows

## 🎯 Benefits

### Developer Experience
- **Better IntelliSense**: TypeScript configs provide auto-completion
- **Type Safety**: Compile-time validation of configurations
- **Cleaner Code**: Better separation of concerns
- **Easier Navigation**: Logical file organization

### Maintainability
- **Modular Design**: Changes isolated to specific modules
- **Interface Contracts**: Clear API boundaries
- **Dependency Injection**: Easy to swap implementations
- **Error Handling**: Centralized error management

### Extensibility
- **Plugin Architecture**: Easy to add new font processors
- **Configuration Flexibility**: Environment-specific configs
- **Service Abstraction**: Easy to add new services
- **CLI Commands**: Easy to add new commands

## 🚀 Implementation Timeline

**Estimated Duration**: 2-3 hours

### Hour 1: Core Infrastructure
- Create directory structure
- Define interfaces
- Implement base classes

### Hour 2: Configuration & Module Migration  
- Convert configs to TypeScript
- Move existing modules to new structure
- Update imports and dependencies

### Hour 3: Integration & Finalization
- Update CLI and main entry point
- Update configuration files
- Test workflows and fix issues

## 📝 Notes

- No testing infrastructure in v3.0 to keep focus on production code
- Can add testing later as v3.1 or v4.0
- All existing functionality will be preserved
- Backwards compatibility maintained through proper interfaces

## 🔄 Rollback Plan

If migration encounters issues:
1. Git checkout to previous version
2. Keep v2.0 branch as backup
3. Incremental migration approach (module by module)

## ✅ Success Criteria

- [ ] All existing workflows work without changes
- [ ] TypeScript configuration fully functional
- [ ] Modular architecture implemented
- [ ] Interface-based design working
- [ ] CLI enhanced with better UX
- [ ] Code organization significantly improved
- [ ] No breaking changes to existing scripts

---

**Status**: Ready for implementation  
**Next Action**: Begin Phase 1 - Core Infrastructure setup
