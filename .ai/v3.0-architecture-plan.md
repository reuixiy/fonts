# Web Font Auto-Subsetting Workflow v3.0 - Architecture Reorganization Plan

**Date Created**: 2025å¹´6æœˆ18æ—¥  
**Version**: 3.0.0  
**Status**: In Progress  

## ğŸ“‹ Overview

This document outlines the comprehensive architecture reorganization plan for v3.0, focusing on improved code organization, TypeScript-first configuration, and modular design patterns.

## ğŸ¯ Goals

- **Better Code Organization**: Clear separation of concerns with modular architecture
- **TypeScript Configuration**: Replace JSON configs with type-safe TypeScript files
- **Interface-Based Design**: Implement dependency injection and loose coupling
- **Enhanced Maintainability**: Easier to extend, test, and maintain
- **No Test Overhead**: Focus on production code without testing infrastructure

## ğŸ—ï¸ Current vs Proposed Structure

### Current Structure (v2.0)
```
src/
â”œâ”€â”€ config/fonts.json          # JSON configuration
â”œâ”€â”€ fontSubset.ts              # Font processing
â”œâ”€â”€ index.ts                   # Main workflow
â”œâ”€â”€ types.ts                   # All types mixed
â””â”€â”€ versionChecker.ts          # Version checking

scripts/
â”œâ”€â”€ download-fonts.ts          # Font downloading
â”œâ”€â”€ generate-css.ts            # CSS generation
â””â”€â”€ generate-license.ts        # License generation
```

### Proposed Structure (v3.0)
```
src/
â”œâ”€â”€ core/                      # Core business logic
â”‚   â”œâ”€â”€ interfaces/            # TypeScript interfaces & contracts
â”‚   â”‚   â”œâ”€â”€ index.ts           # Export all interfaces
â”‚   â”‚   â”œâ”€â”€ IVersionChecker.ts # Version checking contract
â”‚   â”‚   â”œâ”€â”€ IFontDownloader.ts # Download contract
â”‚   â”‚   â”œâ”€â”€ IFontProcessor.ts  # Font processing contract
â”‚   â”‚   â”œâ”€â”€ ICSSGenerator.ts   # CSS generation contract
â”‚   â”‚   â”œâ”€â”€ ILicenseGenerator.ts # License contract
â”‚   â”‚   â””â”€â”€ IWorkflow.ts       # Workflow contract
â”‚   â”‚
â”‚   â”œâ”€â”€ services/              # Service implementations
â”‚   â”‚   â”œâ”€â”€ index.ts           # Export all services
â”‚   â”‚   â”œâ”€â”€ WorkflowService.ts # Main workflow orchestration
â”‚   â”‚   â”œâ”€â”€ ErrorHandler.ts    # Centralized error handling
â”‚   â”‚   â”œâ”€â”€ Logger.ts          # Structured logging
â”‚   â”‚   â””â”€â”€ ConfigValidator.ts # Configuration validation
â”‚   â”‚
â”‚   â””â”€â”€ base/                  # Base classes & abstractions
â”‚       â”œâ”€â”€ BaseService.ts     # Common service functionality
â”‚       â”œâ”€â”€ BaseProcessor.ts   # Common processing functionality
â”‚       â””â”€â”€ ServiceContainer.ts # Dependency injection container
â”‚
â”œâ”€â”€ modules/                   # Feature modules
â”‚   â”œâ”€â”€ version/               # Version checking module
â”‚   â”‚   â”œâ”€â”€ index.ts           # Module exports
â”‚   â”‚   â”œâ”€â”€ VersionChecker.ts  # Main implementation
â”‚   â”‚   â”œâ”€â”€ GitHubVersionService.ts # GitHub API integration
â”‚   â”‚   â”œâ”€â”€ VersionCache.ts    # Version caching logic
â”‚   â”‚   â””â”€â”€ types.ts           # Version-specific types
â”‚   â”‚
â”‚   â”œâ”€â”€ download/              # Font downloading module
â”‚   â”‚   â”œâ”€â”€ index.ts           # Module exports
â”‚   â”‚   â”œâ”€â”€ FontDownloader.ts  # Main implementation
â”‚   â”‚   â”œâ”€â”€ GitHubDownloadService.ts # GitHub download logic
â”‚   â”‚   â”œâ”€â”€ FileValidator.ts   # File validation
â”‚   â”‚   â””â”€â”€ types.ts           # Download-specific types
â”‚   â”‚
â”‚   â”œâ”€â”€ processing/            # Font processing module
â”‚   â”‚   â”œâ”€â”€ index.ts           # Module exports
â”‚   â”‚   â”œâ”€â”€ FontProcessor.ts   # Main implementation
â”‚   â”‚   â”œâ”€â”€ ChunkingService.ts # Font chunking logic
â”‚   â”‚   â”œâ”€â”€ SubsetService.ts   # Font subsetting logic
â”‚   â”‚   â””â”€â”€ types.ts           # Processing-specific types
â”‚   â”‚
â”‚   â”œâ”€â”€ css/                   # CSS generation module
â”‚   â”‚   â”œâ”€â”€ index.ts           # Module exports
â”‚   â”‚   â”œâ”€â”€ CSSGenerator.ts    # Main implementation
â”‚   â”‚   â”œâ”€â”€ TemplateService.ts # CSS template handling
â”‚   â”‚   â”œâ”€â”€ MinificationService.ts # CSS minification
â”‚   â”‚   â””â”€â”€ types.ts           # CSS-specific types
â”‚   â”‚
â”‚   â””â”€â”€ license/               # License generation module
â”‚       â”œâ”€â”€ index.ts           # Module exports
â”‚       â”œâ”€â”€ LicenseGenerator.ts # Main implementation
â”‚       â”œâ”€â”€ LicenseCollector.ts # License data collection
â”‚       â””â”€â”€ types.ts           # License-specific types
â”‚
â”œâ”€â”€ config/                    # TypeScript configuration management
â”‚   â”œâ”€â”€ index.ts               # Configuration loader & validator
â”‚   â”œâ”€â”€ schema.ts              # Type definitions & validation
â”‚   â”œâ”€â”€ fonts/                 # Font configurations (TypeScript)
â”‚   â”‚   â”œâ”€â”€ index.ts           # Combined font config
â”‚   â”‚   â”œâ”€â”€ chinese.ts         # Chinese fonts config
â”‚   â”‚   â”œâ”€â”€ english.ts         # English fonts config
â”‚   â”‚   â””â”€â”€ variable.ts        # Variable fonts config
â”‚   â”‚
â”‚   â”œâ”€â”€ build.ts               # Build configuration
â”‚   â”œâ”€â”€ subsetting.ts          # Subsetting configuration
â”‚   â””â”€â”€ environments/          # Environment-specific configs
â”‚       â”œâ”€â”€ development.ts
â”‚       â”œâ”€â”€ production.ts
â”‚       â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ utils/                     # Shared utilities
â”‚   â”œâ”€â”€ index.ts               # Export all utilities
â”‚   â”œâ”€â”€ FileSystem.ts          # File system operations
â”‚   â”œâ”€â”€ PathUtils.ts           # Path manipulation
â”‚   â”œâ”€â”€ HashUtils.ts           # Hashing utilities
â”‚   â”œâ”€â”€ CompressionUtils.ts    # Compression utilities
â”‚   â””â”€â”€ ValidationUtils.ts     # Common validation
â”‚
â”œâ”€â”€ types/                     # Organized type definitions
â”‚   â”œâ”€â”€ index.ts               # Export all types
â”‚   â”œâ”€â”€ common.ts              # Common/shared types
â”‚   â”œâ”€â”€ config.ts              # Configuration types
â”‚   â”œâ”€â”€ workflow.ts            # Workflow types
â”‚   â”œâ”€â”€ font.ts                # Font-related types
â”‚   â”œâ”€â”€ api.ts                 # API response types
â”‚   â””â”€â”€ build.ts               # Build/output types
â”‚
â”œâ”€â”€ cli/                       # Command line interface
â”‚   â”œâ”€â”€ index.ts               # CLI entry point
â”‚   â”œâ”€â”€ commands/              # Command implementations
â”‚   â”‚   â”œâ”€â”€ build.ts           # Build command
â”‚   â”‚   â”œâ”€â”€ check.ts           # Version check command
â”‚   â”‚   â”œâ”€â”€ process.ts         # Process specific fonts
â”‚   â”‚   â””â”€â”€ clean.ts           # Cleanup command
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                 # CLI utilities
â”‚   â”‚   â”œâ”€â”€ args.ts            # Argument parsing
â”‚   â”‚   â”œâ”€â”€ help.ts            # Help text generation
â”‚   â”‚   â””â”€â”€ validation.ts      # Input validation
â”‚   â”‚
â”‚   â””â”€â”€ types.ts               # CLI-specific types
â”‚
â””â”€â”€ index.ts                   # Main entry point (simplified)
```

## ğŸ”§ Key Architectural Changes

### 1. Interface-Based Design
- All services implement interfaces for better abstraction
- Dependency injection for loose coupling
- Easy to mock and test (when tests are added later)

### 2. TypeScript-First Configuration
- Replace JSON configurations with TypeScript files
- Type-safe configuration with compile-time validation
- Better IntelliSense and refactoring support

### 3. Modular Architecture
- Feature-based module organization
- Clear boundaries between modules
- Easier to maintain and extend

### 4. Service Container
- Centralized dependency management
- Easy to swap implementations
- Better error handling and logging

## ğŸ“‹ Migration Steps

### Phase 1: Core Infrastructure
1. Create new directory structure
2. Define interfaces for all services
3. Implement base classes and service container
4. Set up error handling and logging

### Phase 2: Configuration Migration
1. Convert JSON configs to TypeScript
2. Create configuration schemas and validation
3. Update configuration loading logic

### Phase 3: Module Migration
1. Move version checking to modules/version/
2. Move font downloading to modules/download/
3. Move font processing to modules/processing/
4. Move CSS generation to modules/css/
5. Move license generation to modules/license/

### Phase 4: CLI Enhancement
1. Implement command-based CLI
2. Add proper argument parsing
3. Enhance help and validation

### Phase 5: Integration & Testing
1. Update main entry point
2. Update package.json scripts
3. Update tsconfig.json paths
4. Test all workflows

## ğŸ¯ Benefits

### Developer Experience
- **Better IntelliSense**: TypeScript configs provide auto-completion
- **Type Safety**: Compile-time validation of configurations
- **Cleaner Code**: Better separation of concerns
- **Easier Navigation**: Logical file organization

### Maintainability
- **Modular Design**: Changes isolated to specific modules
- **Interface Contracts**: Clear API boundaries
- **Dependency Injection**: Easy to swap implementations
- **Error Handling**: Centralized error management

### Extensibility
- **Plugin Architecture**: Easy to add new font processors
- **Configuration Flexibility**: Environment-specific configs
- **Service Abstraction**: Easy to add new services
- **CLI Commands**: Easy to add new commands

## ğŸš€ Implementation Timeline

**Estimated Duration**: 2-3 hours

### Hour 1: Core Infrastructure
- Create directory structure
- Define interfaces
- Implement base classes

### Hour 2: Configuration & Module Migration  
- Convert configs to TypeScript
- Move existing modules to new structure
- Update imports and dependencies

### Hour 3: Integration & Finalization
- Update CLI and main entry point
- Update configuration files
- Test workflows and fix issues

## ğŸ“ Notes

- No testing infrastructure in v3.0 to keep focus on production code
- Can add testing later as v3.1 or v4.0
- All existing functionality will be preserved
- Backwards compatibility maintained through proper interfaces

## ğŸ”„ Rollback Plan

If migration encounters issues:
1. Git checkout to previous version
2. Keep v2.0 branch as backup
3. Incremental migration approach (module by module)

## âœ… Success Criteria

- [ ] All existing workflows work without changes
- [ ] TypeScript configuration fully functional
- [ ] Modular architecture implemented
- [ ] Interface-based design working
- [ ] CLI enhanced with better UX
- [ ] Code organization significantly improved
- [ ] No breaking changes to existing scripts

---

**Status**: Ready for implementation  
**Next Action**: Begin Phase 1 - Core Infrastructure setup
